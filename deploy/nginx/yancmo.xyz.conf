# Nginx configuration for yancmo.xyz
server {
    listen 80;
    server_name yancmo.xyz www.yancmo.xyz;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yancmo.xyz www.yancmo.xyz;

    # SSL Configuration
    ssl_certificate /home/yancmo/apps/server-stack-monorepo-v2/shared/ssl/dev.crt;
    ssl_certificate_key /home/yancmo/apps/server-stack-monorepo-v2/shared/ssl/dev.key;
    
    # SSL Settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security Headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Main website root
    root /var/www/yancmo.xyz;
    index index.html index.htm;

    # Default location for main website
    location / {
        try_files $uri $uri/ =404;
    }

    # Dashboard Service
    location /dashboard/ {
        proxy_pass http://localhost:5550/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect / /dashboard/;
        
        # WebSocket support for interactive features
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Cruise Price Check Service
    location /cruise/ {
        proxy_pass http://localhost:5551/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect / /cruise/;
        
        # Handle JSON API requests
        proxy_set_header Content-Type application/json;
    }

    # Clan Map Service
    location /clan-map/ {
        proxy_pass http://localhost:5552/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect / /clan-map/;
        
        # Handle static assets
        proxy_set_header Accept-Encoding "";
        proxy_buffering off;
    }

    # QSL Card Creator Service
    location /qsl/ {
        proxy_pass http://localhost:5553/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect / /qsl/;
        
        # Handle file uploads
        client_max_body_size 50M;
        proxy_request_buffering off;
    }

    # Race Tracker Service  
    location /tracker/ {
        # Remove /tracker prefix when forwarding to Flask app
        rewrite ^/tracker/(.*)$ /$1 break;

        proxy_pass http://localhost:5554/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Script-Name /tracker;
        proxy_redirect off;

        # Handle image uploads
        client_max_body_size 100M;
        proxy_request_buffering off;
    }

    # 5K Tracker PWA App
    location /tracker/pwa/ {
        # Strip /tracker/pwa prefix for upstream
        rewrite ^/tracker/pwa/(.*)$ /$1 break;
        proxy_pass http://localhost:5555/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Script-Name /tracker/pwa;
        proxy_redirect off;

        # Handle large uploads if needed
        client_max_body_size 100M;
        proxy_request_buffering off;

        # Fix asset paths in responses for subpath PWA
        sub_filter 'href="/' 'href="/tracker/pwa/';
        sub_filter 'src="/' 'src="/tracker/pwa/';
        sub_filter 'action="/' 'action="/tracker/pwa/';
        sub_filter 'url("/' 'url("/tracker/pwa/';
        sub_filter_once off;
        sub_filter_types text/html text/css text/javascript application/javascript;
    }

    # Pi-hole Admin Interface Proxy (Local)
    location = /pihole {
        return 301 /pihole/admin/;
    }
    
    location /pihole/ {
        # Strip /pihole prefix and proxy to Pi-hole
        rewrite ^/pihole/(.*) /$1 break;
        proxy_pass http://localhost:8080;
        
        # Essential proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Handle redirects properly
        proxy_redirect http://localhost:8080/ /pihole/;
        proxy_redirect / /pihole/;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Fix asset paths in responses
        sub_filter 'href="/' 'href="/pihole/';
        sub_filter 'src="/' 'src="/pihole/';
        sub_filter 'action="/' 'action="/pihole/';
        sub_filter 'url("/' 'url("/pihole/';
        sub_filter_once off;
        sub_filter_types text/html text/css text/javascript application/javascript;
    }

    # API endpoints that don't need path prefix
    location /api/ {
        # Try to route to appropriate service based on path
        if ($request_uri ~* "^/api/cruise/(.*)") {
            proxy_pass http://localhost:5551/api/$1;
        }
        if ($request_uri ~* "^/api/clan-map/(.*)") {
            proxy_pass http://localhost:5552/api/$1;
        }
        if ($request_uri ~* "^/api/qsl/(.*)") {
            proxy_pass http://localhost:5553/api/$1;
        }
        if ($request_uri ~* "^/api/tracker/(.*)") {
            proxy_pass http://localhost:5554/api/$1;
        }
        
        # Default API handling
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
    }

    # Logging
    access_log /var/log/nginx/yancmo.xyz_access.log;
    error_log /var/log/nginx/yancmo.xyz_error.log;
}
