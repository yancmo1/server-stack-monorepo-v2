# Nginx configuration for yancmo.xyz
server {
    listen 80;
    server_name yancmo.xyz www.yancmo.xyz;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yancmo.xyz www.yancmo.xyz;

        # SSL Configuration
    ssl_certificate /home/yancmo/apps/server-stack-monorepo-v2/shared/ssl/dev.crt;
    ssl_certificate_key /home/yancmo/apps/server-stack-monorepo-v2/shared/ssl/dev.key;
    
    # SSL Settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security Headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Main website root
    root /var/www/yancmo.xyz;
    index index.html index.htm;

    # Default location for main website
    location / {
        try_files $uri $uri/ =404;
    }

    # Dashboard App
    location /dashboard/ {
        proxy_pass https://dashboard.yancmo.xyz/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # Cruise Price Check App
    location /cruise/ {
        proxy_pass https://cruise.yancmo.xyz/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # Clan Map Service (now ClashMap)
    location /clan-map/ {
        # Strip prefix so Flask handlers at / work
        rewrite ^/clan-map/(.*)$ /$1 break;
        proxy_pass https://clashmap.yancmo.xyz/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect / /clan-map/;
        
        # Handle static assets
    proxy_set_header Accept-Encoding "";
        proxy_buffering off;

    # Allow embedding clan-map only from this site via CSP, override legacy header
    add_header Content-Security-Policy "frame-ancestors 'self' https://yancmo.xyz" always;
    add_header X-Frame-Options "" always;
    }

    # ClashMap Service - new alias
    location /clashmap/ {
        # Strip prefix so Flask handlers at / work
        rewrite ^/clashmap/(.*)$ /$1 break;
        proxy_pass https://clashmap.yancmo.xyz/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect / /clashmap/;
        
        # Handle static assets
    proxy_set_header Accept-Encoding "";
        proxy_buffering off;

    # Allow embedding clashmap only from this site via CSP, override legacy header
    add_header Content-Security-Policy "frame-ancestors 'self' https://yancmo.xyz" always;
    add_header X-Frame-Options "" always;
    }

    # QSL Card Creator Service
    # Ensure bare /qsl redirects to /qsl/
    location = /qsl {
        return 301 $scheme://$host/qsl/;
    }

    location /qsl/ {
        # Strip /qsl prefix so Flask app mounted at / works as-is
        rewrite ^/qsl/(.*)$ /$1 break;

        proxy_pass https://qsl.yancmo.xyz/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        # Inform upstream that it is mounted under /qsl
        proxy_set_header X-Script-Name /qsl;
        proxy_redirect / /qsl/;
        
        # Handle file uploads
        client_max_body_size 50M;
        proxy_request_buffering off;

        # Fix asset paths in responses to include /qsl prefix
        sub_filter 'href="/' 'href="/qsl/';
        sub_filter 'src="/' 'src="/qsl/';
        sub_filter 'action="/' 'action="/qsl/';
        sub_filter 'url("/' 'url("/qsl/';
        sub_filter_once off;
        sub_filter_types text/html text/css text/javascript application/javascript;
    }

        # Race Tracker PWA App (now Tracker)
    location /tracker/ {
        proxy_pass https://tracker.yancmo.xyz/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # Crumb App (5K Tracker)
    location /crumb/ {
        proxy_pass https://crumb.yancmo.xyz/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # Race Tracker legacy path
    location /race-tracker/ {
        proxy_pass https://tracker.yancmo.xyz/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # Pi-hole Admin Interface Proxy (Local)
    location = /pihole {
        return 301 /pihole/admin/;
    }
    
    location /pihole/ {
        # Strip /pihole prefix and proxy to Pi-hole
        rewrite ^/pihole/(.*) /$1 break;
        proxy_pass http://localhost:8080;
        
        # Essential proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Handle redirects properly
        proxy_redirect http://localhost:8080/ /pihole/;
        proxy_redirect / /pihole/;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Fix asset paths in responses
        sub_filter 'href="/' 'href="/pihole/';
        sub_filter 'src="/' 'src="/pihole/';
        sub_filter 'action="/' 'action="/pihole/';
        sub_filter 'url("/' 'url("/pihole/';
        sub_filter_once off;
        sub_filter_types text/html text/css text/javascript application/javascript;
    }

    # API endpoints that don't need path prefix
    location /api/ {
        # Try to route to appropriate service based on path
        if ($request_uri ~* "^/api/cruise/(.*)") {
            proxy_pass https://cruise.yancmo.xyz/api/$1;
        }
        if ($request_uri ~* "^/api/clan-map/(.*)") {
            proxy_pass https://clashmap.yancmo.xyz/api/$1;
        }
        if ($request_uri ~* "^/api/qsl/(.*)") {
            proxy_pass https://qsl.yancmo.xyz/api/$1;
        }
        if ($request_uri ~* "^/api/tracker/(.*)") {
            proxy_pass https://tracker.yancmo.xyz/api/$1;
        }
        if ($request_uri ~* "^/api/crumb/(.*)") {
            proxy_pass https://crumb.yancmo.xyz/api/$1;
        }
        
        # Default API handling
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
    }

    # Logging
    access_log /var/log/nginx/yancmo.xyz_access.log;
    error_log /var/log/nginx/yancmo.xyz_error.log;
}
