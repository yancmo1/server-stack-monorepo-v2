{% extends "base.html" %}

{% block title %}Create QSL Card - QSL Card Creator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">
                    <i class="fas fa-plus-circle text-primary me-2"></i>
                    Create QSL Card
                </h3>
            </div>
            <div class="card-body">
                <form id="qslForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="callsign" class="form-label">
                                <i class="fas fa-user me-1"></i>Callsign *
                            </label>
                            <input type="text" class="form-control" id="callsign" name="callsign" 
                                   required placeholder="W5XY" style="text-transform: uppercase;">
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-1" id="loadQsoBtn">
                                <i class="fas fa-search me-1"></i>Load from Log
                            </button>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="date" class="form-label">
                                <i class="fas fa-calendar me-1"></i>Date *
                            </label>
                            <input type="date" class="form-control" id="date" name="date" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="time" class="form-label">
                                <i class="fas fa-clock me-1"></i>Time (UTC)
                            </label>
                            <input type="text" class="form-control" id="time" name="time" 
                                   placeholder="18:45 (optional - current time used if blank)" 
                                   pattern="[0-9]{2}:[0-9]{2}">
                            <div class="form-text">Format: HH:MM (24-hour UTC time)</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="freq" class="form-label">
                                <i class="fas fa-wave-square me-1"></i>Frequency (MHz)
                            </label>
                            <input type="text" class="form-control" id="freq" name="freq" 
                                   placeholder="14.205" step="0.001">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="mode" class="form-label">
                                <i class="fas fa-broadcast-tower me-1"></i>Mode
                            </label>
                            <select class="form-select" id="mode" name="mode">
                                <option value="">Select Mode</option>
                                <option value="SSB">SSB</option>
                                <option value="CW">CW</option>
                                <option value="FM">FM</option>
                                <option value="AM">AM</option>
                                <option value="FT8">FT8</option>
                                <option value="FT4">FT4</option>
                                <option value="PSK31">PSK31</option>
                                <option value="RTTY">RTTY</option>
                                <option value="JT65">JT65</option>
                                <option value="JT9">JT9</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="rst" class="form-label">
                                <i class="fas fa-signal me-1"></i>RST
                            </label>
                            <input type="text" class="form-control" id="rst" name="rst" 
                                   placeholder="59" value="59">
                        </div>
                    </div>
                    
                    <!-- Email and QSO Type Row -->
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="email" class="form-label">
                                <i class="fas fa-at me-1"></i>Email Address
                                <span class="text-muted">(auto-lookup via HAMQTH)</span>
                            </label>
                            <div class="input-group">
                                <input type="email" class="form-control" id="email" name="email" 
                                       placeholder="station@example.com">
                                <button type="button" class="btn btn-outline-secondary" id="emailLookupBtn">
                                    <i class="fas fa-search me-1"></i>Lookup
                                </button>
                            </div>
                            <div class="form-text">
                                <span id="emailStatus" class="text-muted">Enter callsign and click "Load from Log" or "Lookup" to auto-fill</span>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="qsltype" class="form-label">
                                <i class="fas fa-envelope me-1"></i>QSO Type
                            </label>
                            <select class="form-select" id="qsltype" name="qsltype">
                                <option value="TNX" selected>TNX</option>
                                <option value="PSE">PSE</option>
                                <option value="QSL">QSL</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- HamQTH Bio Panel (collapsible) -->
                    <div class="row" id="hamqthBioRow" style="display: none;">
                        <div class="col-12">
                            <div class="card border-info mb-3">
                                <div class="card-header d-flex align-items-center justify-content-between">
                                    <span>
                                        <i class="fas fa-id-badge me-2 text-info"></i>
                                        HamQTH Bio
                                    </span>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleBioBtn">
                                        <i class="fas fa-chevron-up me-1"></i>Collapse
                                    </button>
                                </div>
                                <div class="card-body" id="hamqthBioBody">
                                    <pre id="hamqthBioText" class="mb-0" style="white-space: pre-wrap; word-wrap: break-word; font-size: 0.95rem; line-height: 1.3;"></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- QSL Tracking Section -->
                    <div class="row">
                        <div class="col-12">
                            <h5 class="text-muted border-bottom pb-2 mb-3">
                                <i class="fas fa-clipboard-check me-2"></i>QSL Tracking
                            </h5>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="qsl_sent" class="form-label">
                                <i class="fas fa-paper-plane me-1"></i>QSL Sent
                            </label>
                            <select class="form-select" id="qsl_sent" name="qsl_sent">
                                <option value="" selected>No</option>
                                <option value="Requested">Requested</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="qsl_received" class="form-label">
                                <i class="fas fa-inbox me-1"></i>QSL Received
                            </label>
                            <select class="form-select" id="qsl_received" name="qsl_received">
                                <option value="" selected>No</option>
                                <option value="Requested">Requested</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="sent_via" class="form-label">
                                <i class="fas fa-route me-1"></i>Sent Via
                            </label>
                            <select class="form-select" id="sent_via" name="sent_via">
                                <option value="Electronic" selected>Electronic</option>
                                <option value="Direct">Direct</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="received_date" class="form-label">
                                <i class="fas fa-calendar-check me-1"></i>Received Date
                            </label>
                            <input type="date" class="form-control" id="received_date" name="received_date">
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-4 mb-3">
                            <button type="button" class="btn btn-outline-primary w-100" id="previewBtn">
                                <i class="fas fa-eye me-2"></i>Preview
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-download me-2"></i>Generate PDF
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button type="button" class="btn btn-success w-100" id="emailBtn">
                                <i class="fas fa-envelope me-2"></i>Send Email
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Email Setup Modal - Custom System (No Bootstrap) -->
                <div class="modal" id="emailModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-envelope me-2"></i>Send QSL Email
                                </h5>
                                <button type="button" class="btn-close" id="emailModalClose" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="emailForm">
                                    <div class="row">
                                        <div class="col-md-8 mb-3">
                                            <label for="email_address" class="form-label">
                                                <i class="fas fa-at me-1"></i>Email Address *
                                            </label>
                                            <input type="email" class="form-control" id="email_address" name="email_address" 
                                                   required placeholder="station@example.com">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">&nbsp;</label>
                                            <div class="btn-group w-100">
                                                <button type="button" class="btn btn-outline-secondary" id="hamqthModalBtn">
                                                    <i class="fas fa-search me-1"></i>HAMQTH Lookup
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- HAMQTH Credentials Setup -->
                                    <div class="row mb-3" id="hamqthCredentialsSetup" style="display: none;">
                                        <div class="col-12">
                                            <div class="alert alert-info">
                                                <h6><i class="fas fa-key me-1"></i>HAMQTH Credentials Required</h6>
                                                <p class="mb-2">To use HAMQTH email lookup, please enter your credentials:</p>
                                                <div class="row">
                                                    <div class="col-md-6 mb-2">
                                                        <input type="text" class="form-control form-control-sm" 
                                                               id="hamqthUsername" placeholder="Your callsign">
                                                    </div>
                                                    <div class="col-md-6 mb-2">
                                                        <input type="password" class="form-control form-control-sm" 
                                                               id="hamqthPassword" placeholder="Your password">
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-primary" id="saveHamqthCredentials">
                                                    Save & Test Credentials
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-12 mb-3">
                                            <label for="email_template" class="form-label">
                                                <i class="fas fa-file-alt me-1"></i>Email Template
                                            </label>
                                            <select class="form-select" id="email_template" name="template_type">
                                                <option value="qsl_confirmation" selected>QSL Confirmation</option>
                                                <option value="tnx_qsl">Thanks for QSL Card</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Gmail Integration:</strong> Clicking "Send Email" will open Gmail in your browser 
                                        with a pre-filled email using the selected template and QSO data.
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" id="emailModalCancel">Cancel</button>
                                <button type="button" class="btn btn-primary" id="sendEmailBtn">
                                    <i class="fas fa-envelope me-1"></i>Open Gmail Draft
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Gmail URL Modal for Headless Environments -->
                <div class="modal" id="gmailUrlModal" tabindex="-1" aria-labelledby="gmailUrlModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="gmailUrlModalLabel">
                                    <i class="fas fa-external-link-alt me-2"></i>Gmail URL Ready
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Remote Server Access:</strong> Gmail cannot be opened automatically from this server.
                                    Please copy the URL below and open it in your browser.
                                </div>
                                
                                <div class="mb-3">
                                    <label for="gmailUrlText" class="form-label">Gmail Compose URL:</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="gmailUrlText" readonly>
                                        <button class="btn btn-outline-secondary" type="button" id="copyGmailUrl">
                                            <i class="fas fa-copy me-1"></i>Copy
                                        </button>
                                    </div>
                                    <div class="d-grid">
                                        <a href="#" id="gmailClickableLink" class="btn btn-primary" target="_blank">
                                            <i class="fas fa-external-link-alt me-1"></i>Open Gmail Draft
                                        </a>
                                    </div>
                                </div>
                                
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Email Ready:</strong> <span id="gmailUrlMessage"></span>
                                </div>
                                
                                <div class="text-muted small">
                                    <strong>Instructions:</strong>
                                    <ol class="mb-0">
                                        <li>Copy the URL above</li>
                                        <li>Open it in your browser</li>
                                        <li>Gmail will open with your QSL email pre-filled</li>
                                        <li>Review the content and send the email</li>
                                    </ol>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" id="openGmailUrl">
                                    <i class="fas fa-external-link-alt me-1"></i>Try Opening Gmail
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Preview Area -->
                <div id="previewArea" class="mt-4" style="display: none;">
                    <h5>
                        <i class="fas fa-eye me-2"></i>Preview
                    </h5>
                    <div class="text-center">
                        <img id="previewImage" class="img-fluid border rounded" style="max-width: 100%; height: auto;">
                    </div>
                </div>
                
                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="text-center mt-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating preview...</p>
                </div>
                
                <!-- QSO Selection Modal -->
                <div class="modal" id="qsoSelectionModal" tabindex="-1" style="display: none;">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-list me-2"></i>Multiple QSOs Found - Select One
                                </h5>
                                <button type="button" class="btn-close" id="qsoSelectionModalClose" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Multiple QSOs found for this callsign. Please select the one you want to create a QSL card for.
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Select</th>
                                                <th>Date</th>
                                                <th>Time (UTC)</th>
                                                <th>Frequency</th>
                                                <th>Mode</th>
                                                <th>Band</th>
                                                <th>RST Sent</th>
                                            </tr>
                                        </thead>
                                        <tbody id="qsoSelectionTableBody">
                                            <!-- QSO rows will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" id="qsoSelectionModalCancel">Cancel</button>
                                <button type="button" class="btn btn-primary" id="qsoSelectionModalSelect" disabled>
                                    <i class="fas fa-check me-1"></i>Use Selected QSO
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('qslForm');
    const previewBtn = document.getElementById('previewBtn');
    const loadQsoBtn = document.getElementById('loadQsoBtn');
    const previewArea = document.getElementById('previewArea');
    const previewImage = document.getElementById('previewImage');
    const loadingSpinner = document.getElementById('loadingSpinner');
    // HamQTH Bio elements
    const hamqthBioRow = document.getElementById('hamqthBioRow');
    const hamqthBioText = document.getElementById('hamqthBioText');
    const hamqthBioBody = document.getElementById('hamqthBioBody');
    const toggleBioBtn = document.getElementById('toggleBioBtn');
    
    // Set current date as default
    document.getElementById('date').valueAsDate = new Date();
    
    // Load email templates when page loads
    loadEmailTemplates();
    
    // Check if callsign was provided in URL and auto-load
    const urlParams = new URLSearchParams(window.location.search);
    const urlCallsign = urlParams.get('callsign');
    if (urlCallsign) {
        document.getElementById('callsign').value = urlCallsign.toUpperCase();
        // Auto-load QSO data
        loadQSOData(urlCallsign.toUpperCase());
    }

    // HamQTH Bio helpers
    function setHamqthBio(text) {
        if (!hamqthBioRow || !hamqthBioText) return;
        if (text && String(text).trim().length > 0) {
            hamqthBioText.textContent = text;
            hamqthBioRow.style.display = '';
        } else {
            // If no bio, hide the section
            hamqthBioText.textContent = '';
            hamqthBioRow.style.display = 'none';
        }
    }

    if (toggleBioBtn && hamqthBioBody) {
        toggleBioBtn.addEventListener('click', function() {
            const isHidden = hamqthBioBody.style.display === 'none';
            hamqthBioBody.style.display = isHidden ? '' : 'none';
            toggleBioBtn.innerHTML = isHidden
                ? '<i class="fas fa-chevron-up me-1"></i>Collapse'
                : '<i class="fas fa-chevron-down me-1"></i>Expand';
        });
    }
    
    // Function to load QSO data
    function loadQSOData(callsign) {
        if (!callsign) {
            alert('Please enter a callsign first');
            return;
        }
        
        // First, check how many QSOs exist for this callsign
        fetch(`/qsos/${callsign}`)
            .then(response => response.json())
            .then(data => {
                console.log('QSO data received:', data);
                if (data.error) {
                    if (urlCallsign) {
                        // If auto-loaded from URL, just show a subtle notice
                        console.log('QSO not found for:', callsign);
                    } else {
                        alert('QSO not found: ' + data.error);
                    }
                } else if (data.count === 1) {
                    // Only one QSO - load it directly
                    populateFormWithQSO(data.qsos[0]);
                    if (!urlCallsign) {
                        alert('QSO data loaded successfully!');
                    }
                } else if (data.count > 1) {
                    // Multiple QSOs - show selection modal
                    showQSOSelectionModal(data.qsos);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (!urlCallsign) {
                    alert('Error loading QSO data');
                }
            });
    }
    
    // Function to populate form with QSO data
    function populateFormWithQSO(qsoData) {
        if (qsoData.date) document.getElementById('date').value = qsoData.date;
        if (qsoData.time) {
            console.log('Time received:', qsoData.time);
            // Append UTC to time for clarity and 24-hour format display
            const timeWithUTC = qsoData.time + ' UTC';
            document.getElementById('time').value = timeWithUTC;
            console.log('Time field set to:', timeWithUTC);
        }
        if (qsoData.frequency) document.getElementById('freq').value = qsoData.frequency;
        if (qsoData.mode) document.getElementById('mode').value = qsoData.mode;
        if (qsoData.rst_sent) document.getElementById('rst').value = qsoData.rst_sent;
        if (qsoData.email) document.getElementById('email').value = qsoData.email;
    }
    
    // Function to show QSO selection modal
    function showQSOSelectionModal(qsos) {
        const modal = document.getElementById('qsoSelectionModal');
        const tableBody = document.getElementById('qsoSelectionTableBody');
        const selectBtn = document.getElementById('qsoSelectionModalSelect');
        
        // Clear existing rows
        tableBody.innerHTML = '';
        
        // Add rows for each QSO
        qsos.forEach((qso, index) => {
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            
            const formattedDate = qso.date || 'Unknown';
            const formattedTime = qso.time ? qso.time + ' UTC' : 'Unknown';
            const formattedFreq = qso.frequency ? qso.frequency + ' MHz' : 'Unknown';
            const mode = qso.mode || 'Unknown';
            const band = qso.band || 'Unknown';
            const rstSent = qso.rst_sent || '59';
            
            row.innerHTML = `
                <td><input type="radio" name="qsoSelection" value="${index}" class="form-check-input"></td>
                <td><strong>${formattedDate}</strong></td>
                <td>${formattedTime}</td>
                <td>${formattedFreq}</td>
                <td><span class="badge bg-primary">${mode}</span></td>
                <td><span class="badge bg-secondary">${band}</span></td>
                <td>${rstSent}</td>
            `;
            
            // Make row clickable
            row.addEventListener('click', function(e) {
                if (e.target.type !== 'radio') {
                    const radio = row.querySelector('input[type="radio"]');
                    radio.checked = true;
                    selectBtn.disabled = false;
                }
            });
            
            // Enable select button when radio is selected
            const radio = row.querySelector('input[type="radio"]');
            radio.addEventListener('change', function() {
                selectBtn.disabled = false;
            });
            
            tableBody.appendChild(row);
        });
        
        // Show modal
        modal.style.display = 'flex';
        modal.classList.add('custom-show');
        document.body.style.overflow = 'hidden';
        
        // Handle selection
        selectBtn.onclick = function() {
            const selectedRadio = document.querySelector('input[name="qsoSelection"]:checked');
            if (selectedRadio) {
                const selectedIndex = parseInt(selectedRadio.value);
                const selectedQSO = qsos[selectedIndex];
                populateFormWithQSO(selectedQSO);
                hideQSOSelectionModal();
                alert('QSO data loaded successfully!');
            }
        };
        
        // Handle modal close
        const closeModal = function() {
            hideQSOSelectionModal();
        };
        
        document.getElementById('qsoSelectionModalClose').onclick = closeModal;
        document.getElementById('qsoSelectionModalCancel').onclick = closeModal;
        
        // Close on backdrop click
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
    }
    
    // Function to hide QSO selection modal
    function hideQSOSelectionModal() {
        const modal = document.getElementById('qsoSelectionModal');
        modal.style.display = 'none';
        modal.classList.remove('custom-show');
        document.body.style.overflow = '';
        
        // Reset select button
        document.getElementById('qsoSelectionModalSelect').disabled = true;
    }
    
    // Load email templates when page loads
    function loadEmailTemplates() {
        fetch('/api/email-templates')
            .then(response => response.json())
            .then(data => {
                if (data.templates && data.templates.length > 0) {
                    const emailTemplateSelect = document.getElementById('email_template');
                    if (emailTemplateSelect) {
                        // Clear existing options
                        emailTemplateSelect.innerHTML = '';
                        
                        // Add templates from API
                        data.templates.forEach(template => {
                            const option = document.createElement('option');
                            option.value = template.key;
                            option.textContent = template.name;
                            // Set qsl_confirmation as default (selected)
                            if (template.key === 'qsl_confirmation') {
                                option.selected = true;
                            }
                            emailTemplateSelect.appendChild(option);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error loading email templates:', error);
                // Keep the hardcoded templates as fallback
            });
    }

    // Convert callsign to uppercase
    document.getElementById('callsign').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });
    
    // Load QSO from database
    loadQsoBtn.addEventListener('click', function() {
        const callsign = document.getElementById('callsign').value;
        loadQSOData(callsign);
    });
    
    // Preview functionality
    previewBtn.addEventListener('click', function() {
        const formData = new FormData(form);
        
        loadingSpinner.style.display = 'block';
        previewArea.style.display = 'none';
        
        fetch('/preview', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.style.display = 'none';
            if (data.success) {
                previewImage.src = data.preview;
                previewArea.style.display = 'block';
            } else {
                alert('Preview error: ' + data.error);
            }
        })
        .catch(error => {
            loadingSpinner.style.display = 'none';
            console.error('Error:', error);
            alert('Error generating preview');
        });
    });
    
    // Form submission for PDF generation
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        
        // Create a temporary form for file download
        const downloadForm = document.createElement('form');
        downloadForm.method = 'POST';
        downloadForm.action = '/generate';
        
        // Copy form data
        for (let [key, value] of formData.entries()) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            downloadForm.appendChild(input);
        }
        
        document.body.appendChild(downloadForm);
        downloadForm.submit();
        document.body.removeChild(downloadForm);
    });
    
    // CUSTOM MODAL SYSTEM - Complete Implementation to Fix Flickering
    const emailBtn = document.getElementById('emailBtn');
    const emailModalElement = document.getElementById('emailModal');
    const emailForm = document.getElementById('emailForm');
    const sendEmailBtn = document.getElementById('sendEmailBtn');
    const emailModalClose = document.getElementById('emailModalClose');
    const emailModalCancel = document.getElementById('emailModalCancel');
    const hamqthModalBtn = document.getElementById('hamqthModalBtn');
    const hamqthCredentialsSetup = document.getElementById('hamqthCredentialsSetup');
    const saveHamqthCredentials = document.getElementById('saveHamqthCredentials');
    
    // Remove ALL Bootstrap modal behavior
    if (emailModalElement) {
        emailModalElement.classList.remove('fade');
        emailModalElement.removeAttribute('data-bs-backdrop');
        emailModalElement.removeAttribute('data-bs-keyboard');
    }
    
    // Custom modal state management
    let isModalOpen = false;
    let modalLocked = false;
    
    // Custom show function - completely bypasses Bootstrap
    function showCustomEmailModal() {
        if (isModalOpen || modalLocked) return;
        
        modalLocked = true;
        console.log('Opening custom modal...');
        
        // Disable page scrolling
        document.body.style.overflow = 'hidden';
        document.body.classList.add('modal-open');
        
        // Show modal using custom class
        emailModalElement.classList.add('custom-show');
        emailModalElement.style.display = 'flex';
        emailModalElement.style.visibility = 'visible';
        emailModalElement.style.opacity = '1';
        
        // Focus management
        setTimeout(() => {
            const emailInput = document.getElementById('email_address');
            if (emailInput) {
                emailInput.focus();
                emailInput.select();
            }
            modalLocked = false;
        }, 100);
        
        isModalOpen = true;
        console.log('Custom modal opened');
    }
    
    // Custom hide function
    function hideCustomEmailModal() {
        if (!isModalOpen || modalLocked) return;
        
        modalLocked = true;
        console.log('Closing custom modal...');
        
        // Hide modal
        emailModalElement.classList.remove('custom-show');
        emailModalElement.style.display = 'none';
        emailModalElement.style.visibility = 'hidden';
        emailModalElement.style.opacity = '0';
        
        // Re-enable page scrolling
        document.body.style.overflow = '';
        document.body.classList.remove('modal-open');
        
        setTimeout(() => {
            modalLocked = false;
        }, 50);
        
        isModalOpen = false;
        console.log('Custom modal closed');
    }
    
    // Modal event handlers
    if (emailBtn) {
        emailBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Validate form first
            const callsign = document.getElementById('callsign').value;
            if (!callsign) {
                alert('Please enter a callsign first');
                return;
            }
            
            // Copy email from main form to modal if present
            const mainEmailField = document.getElementById('email');
            const modalEmailField = document.getElementById('email_address');
            if (mainEmailField && modalEmailField && mainEmailField.value) {
                modalEmailField.value = mainEmailField.value;
            }
            
            showCustomEmailModal();
        });
    }
    
    // Close modal handlers
    if (emailModalClose) {
        emailModalClose.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            hideCustomEmailModal();
        });
    }
    
    if (emailModalCancel) {
        emailModalCancel.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            hideCustomEmailModal();
        });
    }
    
    // Close on backdrop click
    if (emailModalElement) {
        emailModalElement.addEventListener('click', function(e) {
            if (e.target === emailModalElement) {
                hideCustomEmailModal();
            }
        });
    }
    
    // ESC key handling
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && isModalOpen) {
            hideCustomEmailModal();
        }
    });
    
    // EMAIL LOOKUP FUNCTIONALITY FOR MAIN FORM
    const emailLookupBtn = document.getElementById('emailLookupBtn');
    const emailField = document.getElementById('email');
    const emailStatus = document.getElementById('emailStatus');
    const callsignField = document.getElementById('callsign');
    
    // Auto-lookup email when callsign changes (debounced)
    let lookupTimeout = null;
    
    function updateEmailStatus(message, isError = false) {
        if (emailStatus) {
            emailStatus.textContent = message;
            emailStatus.className = isError ? 'text-danger' : 'text-muted';
        }
    }
    
    function performEmailLookup(callsign, isAutoLookup = false) {
        if (!callsign || callsign.length < 3) {
            if (!isAutoLookup) {
                updateEmailStatus('Please enter a valid callsign first', true);
            }
            return;
        }
        
        // Show loading state
        const originalBtnText = emailLookupBtn.innerHTML;
        emailLookupBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Looking up...';
        emailLookupBtn.disabled = true;
        
        updateEmailStatus('Looking up email address...');
        
        // Try HAMQTH API first
        fetch(`/api/hamqth/${callsign.toUpperCase()}`)
            .then(response => response.json())
            .then(data => {
                // If we have a bio, show it regardless of email presence
                if (data && data.bio) {
                    setHamqthBio(data.bio);
                }

                if (data.success && data.email) {
                    // Success! Auto-fill email fields in both main form and modal (if present)
                    const mainEmailField = document.getElementById('email');
                    if (mainEmailField) mainEmailField.value = data.email;
                    const modalEmailField = document.getElementById('email_address');
                    if (modalEmailField) modalEmailField.value = data.email;
                    
                    // Update status message - always show success without popup
                    let statusMessage = `✅ Email found: ${data.email}`;
                    if (data.name) statusMessage += ` (${data.name})`;
                    updateEmailStatus(statusMessage);
                    
                    // No popup for successful email lookup
                } else if (data && data.success) {
                    // Successful lookup but email not available; still may have bio
                    if (data.bio) {
                        updateEmailStatus('ℹ️ Email not listed on HAMQTH. Biography loaded.', false);
                    } else {
                        updateEmailStatus('ℹ️ HAMQTH lookup succeeded but no email provided.', false);
                    }
                } else {
                // API failed - show fallback options
                    const message = (data && (data.error || data.message)) || 'Email not found via API';
                updateEmailStatus(`❌ ${message}. Try browser lookup?`, true);
                if (!isAutoLookup) {
                    const useBrowser = confirm(`${message}\n\nWould you like to open HAMQTH in your browser instead?`);
                    if (useBrowser) {
                        const fallbackUrl = data.fallback_url || `https://www.hamqth.com/${callsign.toUpperCase()}`;
                        window.open(fallbackUrl, '_blank');
                        updateEmailStatus('HAMQTH opened in new tab. Copy email here if found.');
                    }
                }
            }
        })
        .catch(error => {
            console.error('Email lookup error:', error);
            updateEmailStatus('❌ Lookup failed. Check internet connection.', true);
            if (!isAutoLookup) {
                alert('Error during email lookup. Please try again or use browser lookup.');
            }
        })
        .finally(() => {
            // Reset button state
            emailLookupBtn.innerHTML = originalBtnText;
            emailLookupBtn.disabled = false;
        });
    }
    
    // Manual lookup button
    emailLookupBtn.addEventListener('click', function() {
        const callsign = callsignField.value.trim();
        performEmailLookup(callsign, false);
    });
    
    // Auto-lookup when callsign changes (debounced to avoid too many requests)
    callsignField.addEventListener('input', function() {
        const callsign = this.value.trim().toUpperCase();
        this.value = callsign; // Auto-uppercase
        
        // Clear any existing timeout
        if (lookupTimeout) {
            clearTimeout(lookupTimeout);
        }
        
        // Clear email and status if callsign is too short
        if (callsign.length < 3) {
            emailField.value = '';
            updateEmailStatus('Enter callsign and click "Load from Log" or "Lookup" to auto-fill');
            setHamqthBio('');
            return;
        }
        
        // Set a timeout to perform lookup after user stops typing
        lookupTimeout = setTimeout(() => {
            performEmailLookup(callsign, true);
        }, 1500); // Wait 1.5 seconds after user stops typing
    });
    
    // HAMQTH MODAL FUNCTIONALITY
    if (hamqthModalBtn) {
        hamqthModalBtn.addEventListener('click', function() {
            const callsign = document.getElementById('callsign').value;
            if (!callsign) {
                alert('Please enter a callsign first');
                return;
            }
            
            // Show loading state
            hamqthModalBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Looking up...';
            hamqthModalBtn.disabled = true;
            
            // Try HAMQTH XML API lookup
            fetch(`/api/hamqth/${callsign}`)
                .then(response => response.json())
                .then(data => {
                    // Populate bio if available
                    if (data && data.bio) {
                        setHamqthBio(data.bio);
                    }

                    if (data.success && data.email) {
                        // Auto-fill email fields in both main form and modal (if present)
                        const mainEmailField = document.getElementById('email');
                        if (mainEmailField) mainEmailField.value = data.email;
                        const modalEmailField = document.getElementById('email_address');
                        if (modalEmailField) modalEmailField.value = data.email;
                        
                        // Show success message with details
                        let message = `✅ Email found: ${data.email}`;
                        if (data.name) message += `\nName: ${data.name}`;
                        if (data.qth) message += `\nQTH: ${data.qth}`;
                        if (data.country) message += `\nCountry: ${data.country}`;
                        
                        alert(message);
                    } else if (data && data.success) {
                        if (data.bio) {
                            alert('HAMQTH lookup succeeded, but no email listed. Biography has been loaded.');
                        } else {
                            alert('HAMQTH lookup succeeded, but no email provided.');
                        }
                    } else {
                        // API failed - check if credentials are needed
                        const message = (data && (data.error || data.message)) || 'Email not found via API';
                        
                        if (message.includes('credentials') || message.includes('session')) {
                            // Show credentials setup
                            if (hamqthCredentialsSetup) {
                                hamqthCredentialsSetup.style.display = 'block';
                            }
                            alert('HAMQTH credentials required. Please enter your HAMQTH username and password below.');
                        } else {
                            // Offer browser fallback
                            const useBrowser = confirm(`${message}\n\nWould you like to open HAMQTH in your browser instead?`);
                            
                            if (useBrowser && data.fallback_url) {
                                window.open(data.fallback_url, '_blank');
                                alert('HAMQTH opened in new tab. Please copy the email address and paste it below.');
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error during API lookup. Please try browser lookup instead.');
                })
                .finally(() => {
                    // Reset button state
                    hamqthModalBtn.innerHTML = '<i class="fas fa-search me-1"></i>HAMQTH Lookup';
                    hamqthModalBtn.disabled = false;
                });
        });
    }
    
    // HAMQTH Credentials Save functionality
    if (saveHamqthCredentials) {
        saveHamqthCredentials.addEventListener('click', function() {
            const username = document.getElementById('hamqthUsername').value.trim();
            const password = document.getElementById('hamqthPassword').value.trim();
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            // Show loading state
            saveHamqthCredentials.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Testing...';
            saveHamqthCredentials.disabled = true;
            
            // Send credentials to server
            fetch('/api/hamqth-credentials', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ HAMQTH credentials saved and verified successfully!');
                    // Hide credentials setup
                    if (hamqthCredentialsSetup) {
                        hamqthCredentialsSetup.style.display = 'none';
                    }
                    // Clear password field for security
                    document.getElementById('hamqthPassword').value = '';
                } else {
                    alert('❌ Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving credentials. Please try again.');
            })
            .finally(() => {
                // Reset button state
                saveHamqthCredentials.innerHTML = 'Save & Test Credentials';
                saveHamqthCredentials.disabled = false;
            });
        });
    }
    
    // Send email button handler
    if (sendEmailBtn) {
        sendEmailBtn.addEventListener('click', function() {
            const emailAddress = document.getElementById('email_address').value;
            if (!emailAddress) {
                alert('Please enter an email address');
                return;
            }
            
            // Get all form data
            const qslFormData = new FormData(form);
            const emailFormData = new FormData(emailForm);
            
            // Combine form data
            const combinedData = new FormData();
            for (let [key, value] of qslFormData.entries()) {
                combinedData.append(key, value);
            }
            for (let [key, value] of emailFormData.entries()) {
                combinedData.append(key, value);
            }
            
            // Debug: Log the form data being sent (commented out - uncomment for debugging)
            /*
            console.log('=== FORM DATA DEBUG ===');
            console.log('QSL Form Data:');
            for (let [key, value] of qslFormData.entries()) {
                console.log(`  ${key}: '${value}'`);
            }
            console.log('Email Form Data:');
            for (let [key, value] of emailFormData.entries()) {
                console.log(`  ${key}: '${value}'`);
            }
            console.log('Combined Data:');
            for (let [key, value] of combinedData.entries()) {
                console.log(`  ${key}: '${value}'`);
            }
            console.log('======================');
            */
            
            // Send email setup request
            fetch('/email-setup', {
                method: 'POST',
                body: combinedData
            })
            .then(response => response.json())
            .then(function(data) {
                if (data.success) {
                    hideCustomEmailModal && hideCustomEmailModal();

                    var msg = data.message || '';
                    var link = data.drafts_link || '';
                    var html = "<div style='font-size:1.1em;'>" + msg + "</div>";
                    
                    // Check if we need to open Gmail compose
                    if (data.open_gmail && data.gmail_url) {
                        // Open Gmail compose in new tab - only once
                        window.open(data.gmail_url, '_blank');
                        html += "<div style='margin-top:1em; color:#28a745;'>Gmail compose window opened in new tab</div>";
                        
                        // Add attachment reminder if provided
                        if (data.attachment_note) {
                            html += "<div style='margin-top:0.5em; color:#dc3545; font-weight:bold;'>⚠️ " + data.attachment_note + "</div>";
                        }
                    } else if (link) {
                        html += "<div style='margin-top:1em;'><a href='" + link + "' target='_blank' class='btn btn-primary'>Open Gmail Drafts Folder</a></div>";
                    }
                    
                    // Show result message
                    if (typeof window.showCustomModal === 'function') {
                        showCustomModal('QSL Email Setup Complete', html);
                    } else {
                        // Fallback to alert - but don't open Gmail again since it was already opened above
                        alert(msg + (data.attachment_note ? '\n\n⚠️ ' + data.attachment_note : ''));
                        
                        // Only open links if NOT already opened Gmail compose
                        if (!data.open_gmail && link) {
                            window.open(link, '_blank');
                        }
                    }
                } else {
                    alert('Error setting up email: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error setting up email');
            });
        });
    }
    
    // Prevent Bootstrap from interfering with custom modal
    if (window.bootstrap && window.bootstrap.Modal) {
        const originalModal = window.bootstrap.Modal;
        window.bootstrap.Modal = function() {
            console.log('Bootstrap Modal blocked');
            return {
                show: () => console.log('Bootstrap show blocked'),
                hide: () => console.log('Bootstrap hide blocked'),
                dispose: () => console.log('Bootstrap dispose blocked')
            };
        };
    }
    
    // Gmail URL Modal Functions for Headless Environments
    function showGmailUrlModal(gmailUrl, message) {
        const modal = document.getElementById('gmailUrlModal');
        const urlText = document.getElementById('gmailUrlText');
        const messageSpan = document.getElementById('gmailUrlMessage');
        const copyBtn = document.getElementById('copyGmailUrl');
        const openBtn = document.getElementById('openGmailUrl');
        const clickableLink = document.getElementById('gmailClickableLink');
        
        if (!modal || !urlText || !messageSpan || !copyBtn || !openBtn) {
            // Fallback if modal elements are missing
            alert('Gmail URL ready:\n\n' + gmailUrl + '\n\nCopy this URL and open it in your browser to access Gmail with your pre-filled QSL email.');
            return;
        }
        
        // Set the URL and message
        urlText.value = gmailUrl;
        messageSpan.textContent = message;
        
        // Set the clickable link href
        if (clickableLink) {
            clickableLink.href = gmailUrl;
        }
        
        // Copy URL functionality
        copyBtn.onclick = function() {
            urlText.select();
            urlText.setSelectionRange(0, 99999); // For mobile devices
            navigator.clipboard.writeText(gmailUrl).then(function() {
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                copyBtn.classList.add('btn-success');
                copyBtn.classList.remove('btn-outline-secondary');
                
                setTimeout(function() {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('btn-success');
                    copyBtn.classList.add('btn-outline-secondary');
                }, 2000);
            }).catch(function() {
                // Fallback for older browsers
                try {
                    document.execCommand('copy');
                    copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                } catch (e) {
                    alert('Please manually copy the URL from the text field');
                }
            });
        };
        
        // Try opening Gmail functionality
        openBtn.onclick = function() {
            window.open(gmailUrl, '_blank');
        };
        
        // Use custom modal system (same as email modal) instead of Bootstrap
        // Disable page scrolling
        document.body.style.overflow = 'hidden';
        document.body.classList.add('modal-open');
        
        // Show modal using custom class
        modal.classList.add('custom-show');
        modal.style.display = 'flex';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        
        // Add close functionality
        const closeModal = function() {
            modal.classList.remove('custom-show');
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
            modal.style.opacity = '0';
            
            // Re-enable page scrolling
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open');
        };
        
        // Close button functionality
        const closeBtn = modal.querySelector('.btn-close, [data-bs-dismiss="modal"]');
        if (closeBtn) {
            closeBtn.onclick = closeModal;
        }
        
        // Close on backdrop click
        modal.onclick = function(e) {
            if (e.target === modal) {
                closeModal();
            }
        };
        
        // ESC key to close
        const escHandler = function(e) {
            if (e.key === 'Escape') {
                closeModal();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }
    
    // Clear timeout on page unload
    window.addEventListener('beforeunload', function() {
        if (lookupTimeout) {
            clearTimeout(lookupTimeout);
        }
    });
});
</script>
{% endblock %}
