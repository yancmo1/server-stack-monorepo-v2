{% extends 'base.html' %}
{% block title %}Clan Map{% endblock %}
{% block head %}
<style>
  .leaflet-popup-content-wrapper, .leaflet-popup-tip { background:#101a36; color:#e5e7eb; }
  .leaflet-control-attribution { background: rgba(0,0,0,.35); color:#cbd5e1; }
</style>
{% endblock %}
{% block content %}
    <div class="card-clean p-2 p-md-3" style="overflow:hidden;">
        <div class="map-viewport">
            <div id="liveMap" style="width:100%;height:100%;border-radius:12px;"></div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
            (function(){
                const map = L.map('liveMap', {
                    center: [20, 0],
                    zoom: 2,
                    worldCopyJump: true
                });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                const roleColors = {
                    'Leader': 'red',
                    'Co-Leader': 'orange',
                    'Elder': 'purple',
                    'Member': 'blue'
                };
                const roleIcons = {
                    'Leader': { icon: 'star', emoji: '👑' },
                    'Co-Leader': { icon: 'fire', emoji: '🔥' },
                    'Elder': { icon: 'star', emoji: '⭐' },
                    'Member': { icon: 'user', emoji: '👤' }
                };

                fetch('/clan-map/api/players')
                    .then(r => r.json())
                    .then(players => {
                        const toNum = (v) => {
                            if (v === null || v === undefined) return null;
                            const n = typeof v === 'string' ? parseFloat(v) : v;
                            return Number.isFinite(n) ? n : null;
                        };
                        const pins = players
                          .map(p => ({
                            ...p,
                            latitude: toNum(p.latitude),
                            longitude: toNum(p.longitude)
                          }))
                          .filter(p => p.latitude !== null && p.longitude !== null);
                        const group = L.featureGroup();
                        pins.forEach(p => {
                            const role = p.role || 'Member';
                            const rColor = roleColors[role] || 'blue';
                            const rInfo = roleIcons[role] || roleIcons['Member'];
                            const icon = L.AwesomeMarkers.icon({
                                markerColor: rColor,
                                prefix: 'fa',
                                icon: rInfo.icon
                            });
                            try {
                                const marker = L.marker([p.latitude, p.longitude], { icon });
                                const popup = `
                                <div style="font-family:Arial,sans-serif;min-width:200px;">
                                    <h4 style="margin:5px 0;color:${rColor};">${rInfo.emoji} ${p.name}</h4>
                                    <p style="margin:3px 0;"><strong>Role:</strong> ${role}</p>
                                    <p style="margin:3px 0;"><strong>Location:</strong> ${p.location || 'Unknown'}</p>
                                </div>
                            `;
                                marker.bindPopup(popup);
                                marker.bindTooltip(`${rInfo.emoji} ${p.name} (${role})`);
                                marker.addTo(group);
                            } catch (e) {
                                console.warn('Skipping invalid player coordinates', p, e);
                            }
                        });
                        group.addTo(map);
                        if (pins.length) {
                            try { map.fitBounds(group.getBounds().pad(0.2)); } catch(_) {}
                        }
                    })
                    .catch(err => console.error('Failed to load players', err));
            })();
                </script>
            {% endblock %}