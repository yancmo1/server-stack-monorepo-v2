{% extends "base.html" %}

{% block title %}Add Race - Race Tracker{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Race
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Dynamic photo upload logic
let photoCount = 0;
const maxPhotos = 10;
const photoList = document.getElementById('photo-list');
const addPhotoBtn = document.getElementById('add-photo-btn');

function createPhotoRow(idx) {
    const row = document.createElement('div');
    row.className = 'card mb-3 shadow-sm';
    row.style.position = 'relative';
    row.innerHTML = `
        <div class="card-body d-flex flex-column flex-md-row align-items-center gap-3">
            <div class="flex-shrink-0 text-center" style="width:120px;">
                <img id="photo_preview${idx}" src="" alt="Preview" style="display:none;max-width:100%;max-height:100px;border-radius:8px;" />
            </div>
            <div class="flex-grow-1 w-100">
                <input type="file" class="form-control form-control-lg mb-2" id="photo${idx}" name="photo${idx}" accept="image/*">
                <select class="form-select form-select-lg mb-2" id="photo_type${idx}" name="photo_type${idx}">
                    <option value="other">Other</option>
                    <option value="finish">Finish Line</option>
                    <option value="medal">Medal</option>
                    <option value="bib">Race Bib</option>
                </select>
                <input type="text" class="form-control form-control-lg" id="photo_caption${idx}" name="photo_caption${idx}" placeholder="Optional caption">
            </div>
            <button type="button" class="btn btn-danger btn-lg ms-md-3 remove-photo-btn" title="Remove Photo" style="position:absolute;top:10px;right:10px;z-index:2;">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    // Preview logic
    const fileInput = row.querySelector(`#photo${idx}`);
    const previewImg = row.querySelector(`#photo_preview${idx}`);
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                previewImg.src = ev.target.result;
                previewImg.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            previewImg.src = '';
            previewImg.style.display = 'none';
        }
    });
    // Remove logic
    row.querySelector('.remove-photo-btn').addEventListener('click', function() {
        row.remove();
        photoCount--;
        addPhotoBtn.disabled = false;
    });
    return row;
}

addPhotoBtn.addEventListener('click', function() {
    if (photoCount >= maxPhotos) return;
    photoCount++;
    const row = createPhotoRow(photoCount);
    photoList.appendChild(row);
    if (photoCount >= maxPhotos) addPhotoBtn.disabled = true;
});

// Weather auto-fill logic
function getWeather(place, date, time) {
    if (!place || !date || !time) return;
    const status = document.getElementById('weather-status');
    status.textContent = 'Fetching weather...';
    // Use selected time for weather lookup
    const datetime = date + 'T' + time;
    fetch(`/api/weather?place=${encodeURIComponent(place)}&datetime=${encodeURIComponent(datetime)}`)
        .then(r => r.json().then(data => ({ok: r.ok, data})))
        .then(({ok, data}) => {
            if (!ok) {
                if (data && data.error && data.error.includes('geocode')) {
                    status.textContent = 'Could not find location. Please be more specific.';
                } else {
                    status.textContent = data && data.error ? data.error : 'No weather data found.';
                }
                return;
            }
            if (data && data.weather) {
                const w = data.weather;
                let tempUnit = w.unit === 'F' ? '째F' : '째C';
                let wind = w.wind_speed + ' mph';
                let humidity = (w.humidity !== undefined && w.humidity !== null) ? `, humidity ${w.humidity}%` : '';
                let summary = `${w.temperature}${tempUnit}, wind ${wind}${humidity}`;
                document.getElementById('weather').value = summary;
                status.textContent = 'Weather auto-filled.';
            } else {
                status.textContent = 'No weather data found.';
            }
        })
        .catch(() => { status.textContent = 'Could not fetch weather.'; });
}

const locationInput = document.getElementById('location');
const dateInput = document.getElementById('race_date');
const timeInput = document.getElementById('race_time');
const fetchBtn = document.getElementById('fetch-weather-btn');

if (fetchBtn) {
    fetchBtn.addEventListener('click', function() {
        getWeather(locationInput.value, dateInput.value, timeInput.value);
    });
}

locationInput.addEventListener('blur', function() {
    if (dateInput.value && timeInput.value) getWeather(locationInput.value, dateInput.value, timeInput.value);
});

    });
    if (locationInput.value && timeInput.value) getWeather(locationInput.value, dateInput.value, timeInput.value);
});


    if (locationInput.value && dateInput.value) getWeather(locationInput.value, dateInput.value, timeInput.value);
});
</script>
{% endblock %}
    // Weather auto-fill logic
    function getWeather(place, date, time) {
        if (!place || !date || !time) return;
        const status = document.getElementById('weather-status');
        status.textContent = 'Fetching weather...';
        // Use selected time for weather lookup
        const datetime = date + 'T' + time;
        fetch(`/api/weather?place=${encodeURIComponent(place)}&datetime=${encodeURIComponent(datetime)}`)
            .then(r => r.json().then(data => ({ok: r.ok, data})))
            .then(({ok, data}) => {
                if (!ok) {
                    if (data && data.error && data.error.includes('geocode')) {
                        status.textContent = 'Could not find location. Please be more specific.';
                    } else {
                        status.textContent = data && data.error ? data.error : 'No weather data found.';
                    }
                    return;
                }
                if (data && data.weather) {
                    const w = data.weather;
                    let tempUnit = w.unit === 'F' ? '째F' : '째C';
                    let wind = w.wind_speed + ' mph';
                    let humidity = (w.humidity !== undefined && w.humidity !== null) ? `, humidity ${w.humidity}%` : '';
                    let summary = `${w.temperature}${tempUnit}, wind ${wind}${humidity}`;
                    document.getElementById('weather').value = summary;
                    status.textContent = 'Weather auto-filled.';
                } else {
                    status.textContent = 'No weather data found.';
                }
            })
            .catch(() => { status.textContent = 'Could not fetch weather.'; });
    }

    const locationInput = document.getElementById('location');
    const dateInput = document.getElementById('race_date');
    const timeInput = document.getElementById('race_time');
    const fetchBtn = document.getElementById('fetch-weather-btn');
    
    if (fetchBtn) {
        fetchBtn.addEventListener('click', function() {
            getWeather(locationInput.value, dateInput.value, timeInput.value);
        });
    }
    
    locationInput.addEventListener('blur', function() {
        if (dateInput.value && timeInput.value) getWeather(locationInput.value, dateInput.value, timeInput.value);
    });
    
    dateInput.addEventListener('change', function() {
        if (locationInput.value && timeInput.value) getWeather(locationInput.value, dateInput.value, timeInput.value);
    });
    
    timeInput.addEventListener('change', function() {
        if (locationInput.value && dateInput.value) getWeather(locationInput.value, dateInput.value, timeInput.value);
    });


</script>
{% endblock %}
