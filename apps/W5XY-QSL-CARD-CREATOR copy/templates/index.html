{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <h1 class="card-title">
                    <i class="fas fa-radio text-primary me-3"></i>
                    QSL Card Creator
                </h1>
                <p class="card-text lead">Create professional QSL cards from your ham radio contacts</p>
                
                <!-- Main Actions - Moved to Top -->
                <div class="row mt-4">
                    <div class="col-md-6 mb-3">
                        <a href="{{ url_for('create_qsl') }}" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-plus-circle me-2"></i>
                            Create QSL Card
                        </a>
                    </div>
                    <div class="col-md-6 mb-3">
                        <a href="{{ url_for('list_qsos') }}" class="btn btn-outline-primary btn-lg w-100">
                            <i class="fas fa-list me-2"></i>
                            View QSOs
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Database Upload/Download Section - Moved under Create Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-download text-primary me-2"></i>
                    Database Management
                </h5>
                <div class="row">
                    <div class="col-md-8">
                        <p class="mb-2">
                            <strong>Status:</strong> 
                            <span id="db-status">
                                {% if db_exists and db_info %}
                                    ‚úÖ Database loaded ({{ db_info.size_mb }}MB, modified {{ db_info.modified }})
                                {% else %}
                                    ‚ö†Ô∏è No database loaded
                                {% endif %}
                            </span>
                        </p>
                        
                        <!-- Enhanced Debug Information -->
                        <div id="db-debug-info" class="mt-3" style="display: none;">
                            <div class="card border-info">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-bug text-info me-2"></i>Database Debug Information
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>üìä Database Stats:</strong>
                                            <ul class="list-unstyled ms-3 mt-1">
                                                <li id="debug-qso-count">QSOs: <span class="text-muted">Loading...</span></li>
                                                <li id="debug-file-size">Size: <span class="text-muted">Loading...</span></li>
                                                <li id="debug-modified">Modified: <span class="text-muted">Loading...</span></li>
                                                <li id="debug-path">Path: <span class="text-muted">Loading...</span></li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>üîÑ Syncthing Info:</strong>
                                            <ul class="list-unstyled ms-3 mt-1">
                                                <li id="debug-syncthing-folder">Folder ID: <span class="text-muted">Loading...</span></li>
                                                <li id="debug-syncthing-created">Created: <span class="text-muted">Loading...</span></li>
                                                <li id="debug-container-mode">Container Mode: <span class="text-muted">Loading...</span></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <strong>üê≥ Container Info:</strong>
                                        <ul class="list-unstyled ms-3 mt-1">
                                            <li id="debug-is-symlink">Symlink: <span class="text-muted">Loading...</span></li>
                                            <li id="debug-real-path">Real Path: <span class="text-muted">Loading...</span></li>
                                            <li id="debug-container-cwd">Working Dir: <span class="text-muted">Loading...</span></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-small text-muted mb-0">
                            <strong>Download:</strong> Get latest QSOs from OneDrive before creating cards.<br>
                            <strong>Upload:</strong> Save your QSL markings back to OneDrive after sending cards.
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="mb-2">
                            <button class="btn btn-primary me-2" id="download-btn" onclick="downloadDatabase()">
                                <i class="fas fa-download me-1"></i>
                                Download Database
                            </button>
                            <button class="btn btn-success" id="upload-btn" onclick="uploadDatabase()">
                                <i class="fas fa-upload me-1"></i>
                                Upload Database
                            </button>
                        </div>
                        <div class="d-flex gap-2">
                            <button id="refresh-btn" class="btn btn-outline-secondary btn-sm" onclick="refreshDatabaseInfo()">
                                <i class="fas fa-refresh me-1"></i>
                                Refresh Info
                            </button>
                            <button id="debug-toggle-btn" class="btn btn-outline-info btn-sm" onclick="toggleDebugInfo()">
                                <i class="fas fa-bug me-1"></i>
                                Debug Info
                            </button>
                        </div>
                    </div>
                </div>
                <div id="download-progress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">
                            Downloading...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Status - Compact Version at Bottom -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-cog text-secondary me-2"></i>
                    System Status
                </h6>
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <small class="d-flex align-items-center">
                            <i class="fas fa-file-pdf text-warning me-2"></i>
                            <strong>PDF:</strong>
                            <span class="badge ms-2 {{ 'bg-success' if poppler_status else 'bg-danger' }}">
                                {{ 'Ready' if poppler_status else 'Error' }}
                            </span>
                        </small>
                    </div>
                    <div class="col-md-4 mb-2">
                        <small class="d-flex align-items-center">
                            <i class="fas fa-file-image text-info me-2"></i>
                            <strong>Template:</strong>
                            <span class="badge ms-2 {{ 'bg-success' if template_exists else 'bg-warning' }}">
                                {{ 'Available' if template_exists else 'Missing' }}
                            </span>
                        </small>
                    </div>
                    <div class="col-md-4 mb-2">
                        <small class="d-flex align-items-center">
                            <i class="fas fa-database text-success me-2"></i>
                            <strong>Database:</strong>
                            <span class="badge ms-2 {{ 'bg-success' if db_exists else 'bg-warning' }}">
                                {{ 'Connected' if db_exists else 'Missing' }}
                            </span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    Quick Start
                </h6>
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-edit fa-2x text-primary mb-2"></i>
                            <h6 class="small">1. Enter QSO Details</h6>
                            <p class="small text-muted">Fill in callsign, date, frequency, mode, and RST</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-eye fa-2x text-warning mb-2"></i>
                            <h6 class="small">2. Preview</h6>
                            <p class="small text-muted">See how your QSL card will look before generating</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-download fa-2x text-success mb-2"></i>
                            <h6 class="small">3. Download PDF</h6>
                            <p class="small text-muted">Generate and download your professional QSL card</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Database download functionality
function downloadDatabase() {
    const dbStatus = document.getElementById('db-status');
    const downloadProgress = document.getElementById('download-progress');
    const downloadBtn = document.getElementById('download-btn');
    
    // Show progress and disable button
    downloadProgress.style.display = 'block';
    downloadBtn.disabled = true;
    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Downloading...';
    dbStatus.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Downloading database from OneDrive...';
    
    fetch('/api/download-database', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            dbStatus.innerHTML = `<span class="text-success">‚úÖ ${data.message}</span>`;
            // Reload page to show updated database status
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            dbStatus.innerHTML = `<span class="text-danger">‚ùå ${data.error}</span>`;
        }
    })
    .catch(error => {
        dbStatus.innerHTML = `<span class="text-danger">‚ùå Download failed: ${error.message}</span>`;
    })
    .finally(() => {
        // Hide progress and reset button
        downloadProgress.style.display = 'none';
        downloadBtn.disabled = false;
        downloadBtn.innerHTML = '<i class="fas fa-download me-1"></i>Download Database';
    });
}

// Database upload functionality
function uploadDatabase() {
    const dbStatus = document.getElementById('db-status');
    const downloadProgress = document.getElementById('download-progress');
    const uploadBtn = document.getElementById('upload-btn');
    
    // Show progress and disable button
    downloadProgress.style.display = 'block';
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Uploading...';
    dbStatus.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Uploading database to OneDrive...';
    
    fetch('/api/upload-database-to-onedrive', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            dbStatus.innerHTML = `<span class="text-success">‚úÖ ${data.message}</span>`;
        } else {
            dbStatus.innerHTML = `<span class="text-danger">‚ùå ${data.error}</span>`;
        }
    })
    .catch(error => {
        dbStatus.innerHTML = `<span class="text-danger">‚ùå Upload failed: ${error.message}</span>`;
    })
    .finally(() => {
        // Hide progress and reset button
        downloadProgress.style.display = 'none';
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i>Upload Database';
    });
}

function refreshDatabaseInfo() {
    const dbStatus = document.getElementById('db-status');
    const refreshBtn = document.getElementById('refresh-btn');
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Checking...';
    refreshBtn.disabled = true;
    
    fetch('/api/database-info')
    .then(response => response.json())
    .then(data => {
        console.log('Database info response:', data); // Debug log
        
        if (data.exists) {
            dbStatus.innerHTML = `‚úÖ Database loaded (${data.qso_count} QSOs, ${data.size_mb}MB, modified ${data.modified})`;
            
            // Update debug information
            updateDebugInfo(data);
        } else {
            dbStatus.innerHTML = `‚ö†Ô∏è No database loaded - ${data.message || data.error || 'Unknown error'}`;
            
            // Update debug info with error details
            updateDebugInfo(data);
        }
    })
    .catch(error => {
        console.error('Database info error:', error); // Debug log
        dbStatus.innerHTML = `‚ùå Error checking database: ${error.message}`;
    })
    .finally(() => {
        refreshBtn.innerHTML = '<i class="fas fa-refresh me-1"></i>Refresh Info';
        refreshBtn.disabled = false;
    });
}

function updateDebugInfo(data) {
    // Update database stats
    document.getElementById('debug-qso-count').innerHTML = `QSOs: <span class="text-success">${data.qso_count || 'N/A'}</span>`;
    document.getElementById('debug-file-size').innerHTML = `Size: <span class="text-info">${data.size_mb || 'N/A'}MB</span>`;
    document.getElementById('debug-modified').innerHTML = `Modified: <span class="text-primary">${data.modified || 'N/A'}</span>`;
    document.getElementById('debug-path').innerHTML = `Path: <span class="text-muted"><code>${data.database_path || 'N/A'}</code></span>`;
    
    // Update Syncthing info
    if (data.syncthing) {
        document.getElementById('debug-syncthing-folder').innerHTML = `Folder ID: <span class="text-success">${data.syncthing.folder_id || 'N/A'}</span>`;
        document.getElementById('debug-syncthing-created').innerHTML = `Created: <span class="text-info">${data.syncthing.created || 'N/A'}</span>`;
        document.getElementById('debug-container-mode').innerHTML = `Container Mode: <span class="text-success">Syncthing Enabled</span>`;
    } else {
        document.getElementById('debug-syncthing-folder').innerHTML = `Folder ID: <span class="text-warning">Not found</span>`;
        document.getElementById('debug-syncthing-created').innerHTML = `Created: <span class="text-warning">Not found</span>`;
        document.getElementById('debug-container-mode').innerHTML = `Container Mode: <span class="text-warning">No Syncthing</span>`;
    }
    
    // Update container info
    if (data.debug) {
        document.getElementById('debug-is-symlink').innerHTML = `Symlink: <span class="${data.debug.is_symlink ? 'text-warning' : 'text-success'}">${data.debug.is_symlink ? 'Yes' : 'No'}</span>`;
        document.getElementById('debug-real-path').innerHTML = `Real Path: <span class="text-muted"><code>${data.debug.real_path || 'N/A'}</code></span>`;
        document.getElementById('debug-container-cwd').innerHTML = `Working Dir: <span class="text-muted"><code>${data.debug.container_cwd || 'N/A'}</code></span>`;
    }
}

function toggleDebugInfo() {
    const debugDiv = document.getElementById('db-debug-info');
    const toggleBtn = document.getElementById('debug-toggle-btn');
    
    console.log('toggleDebugInfo called'); // Debug log
    console.log('debugDiv:', debugDiv); // Debug log
    console.log('toggleBtn:', toggleBtn); // Debug log
    console.log('Current display style:', debugDiv ? debugDiv.style.display : 'element not found'); // Debug log
    
    if (!debugDiv || !toggleBtn) {
        console.error('Required elements not found!');
        return;
    }
    
    if (debugDiv.style.display === 'none' || debugDiv.style.display === '') {
        debugDiv.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-bug me-1"></i>Hide Debug';
        console.log('Showing debug panel'); // Debug log
        // Refresh debug info when showing
        refreshDatabaseInfo();
    } else {
        debugDiv.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-bug me-1"></i>Debug Info';
        console.log('Hiding debug panel'); // Debug log
    }
}

// Check database info on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshDatabaseInfo();
});
</script>

{% endblock %}
